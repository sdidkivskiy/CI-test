name: CI-CD

on:
  push:
    branches:
      - master

jobs:
  job1:
    build:

      runs-on: ubuntu-latest

      strategy:
        matrix:
          node-version: [12.x]

      steps:
        - uses: actions/checkout@v2
        - name: Use Node.js ${{ matrix.node-version }}
          uses: actions/setup-node@v2
          with:
            node-version: ${{ matrix.node-version }}

        - name: Test the Testcases
          run: |
            npm install
            npm run build --if-present
            npm test

        - name: Login to Docker Hub
          uses: docker/login-action@v1
          with:
            username: ${{ secrets.DOCKER_USERNAME }}
            password: ${{ secrets.DOCKER_PASSWORD }}

        - name: Set up Docker Buildx
          id: Buildx
          uses: docker/setup-buildx-action@v1

        - name: Build and Push
          id: docker_build
          uses: docker/build-push-action@v2
          with:
            context: ./
            file: ./Dockerfile
            push: true
            tags: maz2500z/nodejs-demo

        - name: Image digest
          run: echo ${{ steps.docker_build.outputs.digest }}
  job2:
    deploy_to_VPS:
      runs-on: ubuntu-latest
      needs: job1
      steps:
        - name: Deploy using ssh
          uses: appleboy/ssh-action@master
          with:
            host: ${{ secrets.HOST }}
            username: ${{ secrets.USERNAME }}
            key: ${{ secrets.PRIVATE_KEY }}
            port: 22
            script: |
              cd /root/alex_test
              docker pull maz2500z/nodejs-demo:latest
              docker run -d -p 3000:3000 maz2500z/nodejs-demo
